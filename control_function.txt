<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
	inlineMath: [['$','$']],
	processEscapes: true
	}
});
</script>
<script type="text/javascript" async 
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>

# Control Function

### Isaac M
--------------------------------------------------------------------------------



In this note we study control function (CF) methods. We use data from a RCT in MCLC @sadka, to study the effect of statistical information provided to dismissed workers *when the worker is present* to settlement rates.

~~~~
<<dd_do>>
import delimited "https://raw.githubusercontent.com/isaacmeza/control_function_example/main/DB/cf_pactor_sett.csv", clear  case(preserve)
<</dd_do>>
~~~~


### Constrained model - Constant Coefficients

The model of interest is
$$ y_j = x_j\beta +\delta t_j+\epsilon_j$$

where $t_j$ is a binary-treatment variable generated by an unobservable latent model:
$$t_j = 1[w_j\gamma + u_j>0]$$
and $\epsilon$, $u$ are bivariate normal with mean zero and covariance matrix

$$ \begin{bmatrix} \sigma^2 
& \rho\sigma 
\end{bmatrix}$$ 
$$ \begin{bmatrix}\rho\sigma & 1 
\end{bmatrix}$$ 


We also allow interactions between $x_j$ and the treatment $t_j$. 


The calculator arm ($x_j$) is random, but we might be concerned with the endogeneity of employee presence ($t_j$).  While this is fundamentally an external validity issue (since the calculator is random conditional on the plaintiff's presence), it is relevant for how we interpret the null treatment effect when the employee is not present. To address any concern with the endoegeneity of the plaintiff's presence, we use control function approaches. The dependent variable in this setting ($y_j$) is same-day settlement.




## Two-step CF

For the two-step control function procedure, probit estimates of the (EEV) 
$$\Pr(T_j=1\;|\;w_j) = \Phi(w_j\gamma)$$
are obtained in the first stage.
From these estimates we obtain "generalized residuals" 
$$r_j = t_j(\frac{\phi(w_j\hat{gamma})}{\Phi(w_j\hat{gamma})})+(1-t_j)(-\frac{\phi(w_j\hat{gamma})}{1-\Phi(w_j\hat{gamma})})$$

then
$$\mathbb{E}[y_j\;|\;t_j,x_j,w_j]  = x_j\beta +\deltat_j+\rho\sigma r_j$$
$$\operatorname{Var}(y_j\;|\;t_j,x_j,w_j) = \sigma^2(1-\rho^2(r_j(r_j+w_j\hat\gamma)))$$

the two-step estimates of $\beta$ and $\delta$ are obtained by augmenting the regression with the generalized residuals. The t statistic on $r_j$, made robust to heteroskedasticity, is a valid test of the null that $t_j$ is exogenous.

We "manually" implement the previous approach as follows:

```
*Probit (FS)
probit p_actor i.altT time_hr2-time_hr8 i.anioControl i.numActores i.junta i.phase if e(sample)
cap drop xb
predict xb, xb
*Generalized residuals
cap drop gen_resid_pr
gen gen_resid_pr = cond(p_actor == 1, normalden(xb)/normal(xb), -normalden(xb)/(1-normal(xb)))	

```

As suggested by @Wooldridge, when the EEV $t_j$ interacts with $x_j$ there are other natural choices for IVs: Use the interactions $\Phi(w_j\hat\gamma)x_j$ where $$\Phi(w_j\hat\gamma)$ are the predicted probabilities of $t_j$. This IV estimator has a theoretical advantage over the CF estimator, at least if one assumes the linear model with constant coefficients is the correct specification: The IV estimator is generally consistent even if the probit model is misspecified



### General potential outcome model - Correlated Random Coefficient

 The setup of the previous section allows the endogenous explanatory variable or variables to appear linearly or nonlinearly and to interact with observed covariates. This may be sufficient for some applications, but one may also want to allow the effect of y2 to depend on unobs

 ved fully. When one allows random coefficients to be correlated with some explanatory variables, such as amount of school or choice of school, one obtains a "correlated random coefficient" (CRC) model, a label adopted by Heckman and Vytlacil (1998) and discussed in the context of the return to schooling by Card (2001). In the treatment effects literature, CRC models allow for heterogeneous treatment effects combined with self-selection into treatment â€”provided that there are suitable instrumental variables for treatment as signment


 The recent literature on instrumental variables (IV) features models in which agents sort into treatment status on the basis of gains from treatment as well as on baseline-pretreatment levels. Components of the gains known to the agents and acted on by them may not be known by the observing economist. Such models are called correlated random coefficient models.
 
 
 
```
ivregress 2sls seconcilio altT d_anio* d_num* d_junta* phase (p_actor interactT = i.time_hr##i.altT), vce(cluster cluster_v)   
```

~~~~
<<dd_do : nocommand>>
ivregress 2sls seconcilio altT d_anio* d_num* d_junta* phase (p_actor interactT = i.time_hr##i.altT), vce(cluster cluster_v)   

<</dd_do>>
~~~~

   etregress seconcilio altT i.anioControl i.numActores i.junta i.phase , treat(p_actor = i.time_hr altT i.anioControl i.numActores i.junta i.phase) twostep first
   

*CF
*Probit - Interaction

eststo clear




gen esample = e(sample)

eststo : reg seconcilio altT p_actor   i.anioControl i.numActores i.junta i.phase gen_resid_p  


eststo : reg seconcilio altT i.p_actor##c.gen_resid_p   i.anioControl i.numActores i.junta i.phase   



eststo : reg seconcilio altT p_actor interactT  i.anioControl i.numActores i.junta i.phase gen_resid_p 



*CRC

eststo : reg seconcilio altT i.p_actor##c.gen_resid_p interactT  i.anioControl i.numActores i.junta i.phase 




   



   etregress seconcilio i.altT##i.p_actor i.anioControl i.numActores i.junta i.phase , treat(p_actor = i.time_hr altT i.anioControl i.numActores i.junta i.phase) twostep  

   etregress seconcilio i.altT##i.p_actor i.anioControl i.numActores i.junta i.phase , treat(p_actor = i.time_hr altT i.anioControl i.numActores i.junta i.phase)  cfunction  poutcomes
   
   etregress seconcilio i.altT##i.p_actor i.anioControl i.numActores i.junta i.phase , treat(p_actor = i.time_hr altT i.anioControl i.numActores i.junta i.phase)    poutcomes
   
    etregress seconcilio i.altT##i.p_actor i.anioControl i.numActores i.junta i.phase , treat(p_actor = i.time_hr altT i.anioControl i.numActores i.junta i.phase)  cfunction  
   
   etregress seconcilio i.altT##i.p_actor i.anioControl i.numActores i.junta i.phase , treat(p_actor = i.time_hr altT i.anioControl i.numActores i.junta i.phase)      
   
   
   
   
reg p_actor  i.altT##i.time_hr i.anioControl i.numActores i.junta i.phase if esample
cap drop p1
predict p1
reg interactT i.altT##i.time_hr i.anioControl i.numActores i.junta i.phase if esample
cap drop p2
predict p2

reg seconcilio altT p1 p2 i.anioControl i.numActores i.junta i.phase if esample


ivregress 2sls seconcilio altT   i.anioControl i.numActores i.junta i.phase (p_actor  = i.time_hr), first



probit p_actor  i.altT time_hr2-time_hr8 d_anio* d_num* d_junta* phase
cap drop p1
predict p1

reg seconcilio altT p1 d_anio* d_num* d_junta* phase


cap drop pint
su altT 
gen pint = p1*(altT-`r(mean)')
reg seconcilio altT p1 pint d_anio* d_num* d_junta* phase

 
ivtreatreg seconcilio p_actor altT d_anio* d_num* d_junta* phase , model(direct-2sls) iv(time_hr2-time_hr8) hetero(altT) 
   
ivtreatreg seconcilio p_actor altT d_anio* d_num* d_junta* phase, model(probit-ols) iv(time_hr2-time_hr8) hetero(altT) 
   
di   e(ate)   
di   e(atet)
di  e(atent)


ivtreatreg seconcilio p_actor altT d_anio* d_num* d_junta* phase, model(probit-2sls) iv(time_hr2-time_hr8) hetero(altT) 


ivtreatreg seconcilio p_actor altT d_anio* d_num* d_junta* phase, model(heckit) iv(time_hr2-time_hr8) hetero(altT) 

ivtreatreg seconcilio p_actor altT d_anio* d_num* d_junta* phase, model(heckit) iv(time_hr2-time_hr8) hetero(altT) 


<</dd_do>>
~~~~

el mate 
$$\mathbb{E}[x-y]$$

pero es igual que $a-v$ sdfsdfdfg

y entonces se da que 
